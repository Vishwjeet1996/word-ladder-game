<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Word Ladder Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background color */
            min-height: 100vh;
            color: #e0e0e0;
            overflow-y: hidden;
            /* New centering/alignment for desktop */
            display: flex;
            flex-direction: column;
            align-items: center; /* Center horizontally */
            justify-content: flex-start; /* START content at the top */
            padding-top: 0rem; /* CHANGED: Remove initial padding at the top */
            padding-bottom: 2rem;
        }

        /* Adjust padding for larger screens to pull content further down from the absolute top */
        @media (min-width: 768px) {
            body {
                padding-top: 4rem; 
            }
        }
		
		/* The actual animation definition */
		@keyframes shake {
			0% { transform: translateX(0); }
			20% { transform: translateX(-6px); }
			40% { transform: translateX(6px); }
			60% { transform: translateX(-6px); }
			80% { transform: translateX(6px); }
			100% { transform: translateX(0); }
		}

		/* The class to trigger the animation */
		.shake-error {
			animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
			transform: translate3d(0, 0, 0); 
		}
        
        /* Custom styles for the letter tiles */
        .letter-tile {
            /* Reduced size for small screens, using vw for relative sizing */
            width: 14vw; /* Use viewport width for responsive sizing */
            height: 14vw;
            max-width: 4rem; /* Cap the size for larger screens */
            max-height: 4rem; 
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem; /* Slightly smaller font for tighter fit */
            font-weight: 900;
            cursor: pointer;
            transition: all 0.15s;
			/* 3D properties: */
			transform-style: preserve-3d;
			backface-visibility: hidden;
        }
		
		/* New styles for the winning tiles */
			.win-tile {
				background-color: #10b981 !important; /* Success Color (Green) */
				border-color: #059669 !important; /* Darker green border */
				color: #1f2937 !important; 
				box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.5), 0 4px 6px -2px rgba(16, 185, 129, 0.05); 
			}
			
		@keyframes win-pulse {
			0% { box-shadow: 0 0 0 rgba(16, 185, 129, 0.0); } /* No shadow */
			50% { box-shadow: 0 0 50px 20px rgba(16, 185, 129, 0.8); } /* Bright green glow */
			100% { box-shadow: 0 0 0 rgba(16, 185, 129, 0.0); }
		}

		.win-pulse {
			animation: win-pulse 1s ease-out; /* Match the duration of your tile flips */
		}	

        @media (min-width: 640px) { /* sm breakpoint: restore standard size on tablets/desktop */
            .letter-tile {
                width: 4rem; 
                height: 4rem;
                font-size: 2rem;
            }
        }

        .keyboard-key {
            /* Use viewport width for responsive sizing, but capped */
            width: 8vw; /* Reduced from 8.5vw for a tighter fit on small phones */
            max-width: 3rem; 
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem; 
            font-weight: 700;
            cursor: pointer;
            user-select: none;
            transition: transform 0.1s, background-color 0.1s;
        }
        .keyboard-key:hover {
            transform: translateY(-1px);
            box-shadow: 0 0 10px rgba(71, 85, 105, 0.5); /* Subtle hover effect */
        }

        /* --- Custom scrollbar for history chain (New) --- */
        .custom-scrollbar::-webkit-scrollbar {
            height: 8px; /* height of horizontal scrollbar */
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #2d3748; /* Darker gray for track */
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #8b5cf6; /* Purple thumb */
            border-radius: 10px;
            border: 2px solid #2d3748; /* Border to match track */
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a78bfa; /* Lighter purple on hover */
        }

        /* --- Orientation/Size Check Message --- */
        #orientation-message {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #0d1117; /* Dark background */
            color: #d1d5db; /* Light gray text */
            z-index: 1000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        #game-container {
            /* Ensure content stacks vertically and takes up the central max width */
            display: flex;
            flex-direction: column;
            width: 100%; /* Important for centering to work */
        }

        /* Show message and hide game content if the screen height is too short (e.g., less than 700px). */
        @media (max-height: 700px) {
            #orientation-message {
                display: flex;
            }
            #game-container {
                display: none !important; /* Force hide game content */
            }
            /* Hide scrolling for the small screen warning */
            body {
                overflow: hidden;
            }
        }
        
        /* Ensure the game container is always visible on screens tall enough */
        @media (min-height: 701px) {
            #orientation-message {
                display: none;
            }
        }

        /* --- Congratulations Modal Fixes for Small Screens --- */
        .modal-content-congrats {
            /* Make the congrats modal slightly wider on small screens to fit text better */
            max-width: 90%; 
            margin: auto;
        }
        
        /* Apply font size fix for congratulations modal header */
        .congrats-title {
            font-size: 2rem; /* text-3xl */
        }
        @media (min-width: 640px) { /* sm breakpoint */
            .congrats-title {
                font-size: 2.25rem; /* sm:text-4xl */
            }
        }

    </style>
</head>
<body>

    <div id="orientation-message">
        <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500 mb-6">
            <rect x="2" y="3" width="14" height="18" rx="2" ry="2"/>
            <path d="M7 17v-1.5"/>
            <path d="M10 17v-1.5"/>
            <path d="M17 10h4"/>
            <path d="M17 7h4"/>
            <path d="M17 13h4"/>
            <path d="M21 17c-2-2-4-3.5-4-3.5"/>
            <path d="M21 3c-2 2-4 3.5-4 3.5"/>
            <path d="M17 21c2-2 4-3.5 4-3.5"/>
            <path d="M17 17c2 2 4 3.5 4 3.5"/>
        </svg>
        <p class="text-xl mb-2">Oh no! We can't fit everything on your screen.</p>
        <p class="text-2xl font-bold">Please rotate your device.</p>
    </div>

    <div id="message-box" class="fixed top-4 sm:top-10 left-1/2 transform -translate-x-1/2 flex items-center p-4 rounded-xl text-white shadow-2xl transition-opacity duration-300 z-50 max-w-sm" 
         style="background-color: #3b82f6; opacity: 0; visibility: hidden; pointer-events: none;"
         role="alert">        
        <span id="message-text" class="font-medium">Enter the new letter for position 2.</span>
    </div>

    <div id="game-container" class="w-full max-w-lg p-4 sm:p-0 space-y-6">

        <div id="level-selector-screen" class="bg-[#161b22] rounded-lg shadow-lg p-6 relative">
            
            <h1 class="text-4xl md:text-5xl font-extrabold text-center mb-8">
                The <span class="text-emerald-400">Word</span> Ladder Game
            </h1>

            <div class="flex justify-center space-x-4 mb-12">
                <button id="settings-btn" class="open-modal-btn flex items-center px-4 py-2 bg-gray-700 text-white font-bold rounded-xl shadow-md transition-colors hover:bg-gray-600 border-b-4 border-gray-800" data-modal="settings-modal">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.514c.55 0 1.02.398 1.11.94 1.29.548 2.378 1.554 3.076 2.776 1.11 1.956 1.11 4.238 0 6.194a7.55 7.55 0 01-3.076 2.776c-.09.542-.56.94-1.11.94h-2.514c-.55 0-1.02-.398-1.11-.94a7.55 7.55 0 01-3.076-2.776c-1.11-1.956-1.11-4.238 0-6.194a7.55 7.55 0 013.076-2.776zM12 12.75a.75.75 0 100-1.5.75.75 0 000 1.5z" />
                    </svg>
                    Settings
                </button>
                <button id="how-to-play-btn" class="open-modal-btn flex items-center px-4 py-2 bg-purple-600 text-white font-bold rounded-xl shadow-md transition-colors hover:bg-purple-700 border-b-4 border-purple-700" data-modal="how-to-play-modal">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712L12 15l-2.121-2.121c-1.172-1.025-1.172-2.687 0-3.712zM15 11.25a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                    </svg>
                    How to Play
                </button>
            </div>

            <div class="text-center">
                <h2 class="text-3xl font-bold text-yellow-400 mb-6 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 mr-3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" />
                    </svg>
                    Select Level
                </h2>

                <div class="relative inline-block text-left w-full max-w-xs">
                    <div>
                        <button type="button" class="inline-flex justify-between items-center w-full rounded-xl border border-transparent shadow-sm px-6 py-3 bg-purple-600 text-lg font-medium text-white hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-purple-500 transition-colors duration-200" id="level-dropdown-button" aria-expanded="false" aria-haspopup="true">
                            Choose a Level...
                            <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>

                    <div id="level-dropdown-menu" class="dropdown-content origin-top-right absolute right-0 mt-2 w-full rounded-xl shadow-lg bg-[#1e293b] ring-1 ring-black ring-opacity-5 focus:outline-none hidden" role="menu" aria-orientation="vertical" aria-labelledby="level-dropdown-button" tabindex="-1">
                        <div class="py-1" role="none">
                            <button class="level-option group flex items-center px-4 py-3 text-lg text-white hover:bg-gray-700 w-full text-left rounded-t-xl transition-colors duration-200" data-word-length="3" data-level-name="3-Letter Warmup">
                                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-green-500 flex items-center justify-center text-white text-sm font-bold mr-3">3</div>
                                <div>
                                    <p class="font-bold text-green-400">3-Letter Warmup</p>
                                    <p class="text-sm text-gray-400">Quick puzzles with small words. (3 letters)</p>
                                </div>
                            </button>
                            <button class="level-option group flex items-center px-4 py-3 text-lg text-white hover:bg-gray-700 w-full text-left transition-colors duration-200" data-word-length="4" data-level-name="4-Letter Standard">
                                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white text-sm font-bold mr-3">4</div>
                                <div>
                                    <p class="font-bold text-blue-400">4-Letter Standard</p>
                                    <p class="text-sm text-gray-400">The classic Word Chain experience. (4 letters)</p>
                                </div>
                            </button>
                            <button class="level-option group flex items-center px-4 py-3 text-lg text-white hover:bg-gray-700 w-full text-left rounded-b-xl transition-colors duration-200" data-word-length="5" data-level-name="5-Letter Challenge">
                                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-red-500 flex items-center justify-center text-white text-sm font-bold mr-3">5</div>
                                <div>
                                    <p class="font-bold text-red-400">5-Letter Challenge</p>
                                    <p class="text-sm text-gray-400">Longer words requiring careful thought. (5 letters)</p>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div> 
        
        <div id="game-screen" class="hidden w-full max-w-lg p-4 sm:p-0 space-y-6">
    
    <div id="top-bar-controls" class="flex justify-between items-center px-2 py-3">
        <div class="flex space-x-3">
            <button id="settings-btn-game" class="open-modal-btn p-2 rounded-full bg-gray-700 hover:bg-gray-600 transition-colors" data-modal="settings-modal">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-white">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.514c.55 0 1.02.398 1.11.94 1.29.548 2.378 1.554 3.076 2.776 1.11 1.956 1.11 4.238 0 6.194a7.55 7.55 0 01-3.076 2.776c-.09.542-.56.94-1.11.94h-2.514c-.55 0-1.02-.398-1.11-.94a7.55 7.55 0 01-3.076-2.776c-1.11-1.956-1.11-4.238 0-6.194a7.55 7.55 0 013.076-2.776zM12 12.75a.75.75 0 100-1.5.75.75 0 000 1.5z" />
                </svg>
            </button>
            <button id="how-to-play-btn-game" class="open-modal-btn p-2 rounded-full bg-gray-700 hover:bg-gray-600 transition-colors" data-modal="how-to-play-modal">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-white">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712L12 15l-2.121-2.121c-1.172-1.025-1.172-2.687 0-3.712zM15 11.25a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                </svg>
            </button>
        </div>
        <div class="flex space-x-3">
            <button id="reset-word-btn" class="p-2 rounded-full bg-yellow-600 hover:bg-yellow-500 transition-colors text-white font-bold text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.751m-2.885 8.167v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 01-13.803 3.751m-5.462-8.417a8.25 8.25 0 0113.803-3.751" />
                </svg>
            </button>
            <button id="quit-game-btn" class="p-2 rounded-full bg-red-600 hover:bg-red-500 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-white">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H5a3 3 0 01-3-3V7a3 3 0 013-3h5a3 3 0 013 3v1" />
                </svg>
            </button>
        </div>
    </div>


    <header class="text-white text-center">
        <h1 id="game-title" class="text-4xl md:text-5xl font-extrabold text-center mb-6 tracking-tight">
            <span class="text-green-400">5</span>-Letter Challenge
        </h1>
        <div class="flex justify-between items-center text-lg mt-4 border-b border-gray-700 pb-3">
            <div>
                <span class="text-gray-400 font-medium">Start:</span>
                <div id="start-word-display" class="text-2xl font-bold text-blue-400">CLOTH</div>
            </div>
            <div class="text-center">
                <span class="text-gray-400 font-medium">Steps:</span>
                <div id="steps-display-game" class="text-3xl font-extrabold text-yellow-400">0</div>
            </div>
            <div>
                <span class="text-gray-400 font-medium">Goal:</span>
                <div id="goal-word-display" class="text-2xl font-bold text-red-400">SMILE</div>
            </div>
        </div>
    </header>

    <div class="flex items-center justify-center p-4 rounded-xl bg-gray-800 shadow-xl">
        <div id="current-word" class="flex space-x-1">
            </div>
    </div>
    
    <div class="flex items-center justify-center px-4 py-2 rounded-xl bg-gray-800 shadow-xl space-x-4">
        <div id="history-scroll-container" class="w-full overflow-x-auto whitespace-nowrap py-0.5 custom-scrollbar">
            <div id="ladder-history" class="text-white text-lg font-mono inline-flex items-center space-x-2">
                </div>
        </div>
    </div>

    <div class="p-4 rounded-xl bg-gray-800 shadow-xl mt-6">
        <div id="keyboard" class="space-y-2">
            <div class="flex justify-center space-x-1 sm:space-x-2">
                <div class="keyboard-key bg-gray-600 text-white rounded-lg" data-key="Q">Q</div>
                <div class="keyboard-key bg-gray-600 text-white rounded-lg" data-key="W">W</div>
                <div class="keyboard-key bg-gray-600 text-white rounded-lg" data-key="E">E</div>
                <div class="keyboard-key bg-gray-600 text-white rounded-lg" data-key="R">R</div>
                <div class="keyboard-key bg-gray-600 text-white rounded-lg" data-key="T">T</div>
                <div class="keyboard-key bg-gray-600 text-white rounded-lg" data-key="Y">Y</div>
                <div class="keyboard-key bg-gray-600 text-white rounded-lg" data-key="U">U</div>
                <div class="keyboard-key bg-gray-600 text-white rounded-lg" data-key="I">I</div>
                <div class="keyboard-key bg-gray-600 text-white rounded-lg" data-key="O">O</div>
                <div class="keyboard-key bg-gray-600 text-white rounded-lg" data-key="P">P</div>
            </div>
            <div class="flex justify-center space-x-1 sm:space-x-2">
                <div class="keyboard-key bg-gray-600 text-white rounded-lg" data-key="A">A</div>
                <div class="keyboard-key bg-gray-600 text-white rounded-lg" data-key="S">S</div>
                <div class="keyboard-key bg-gray-600 text-white rounded-lg" data-key="D">D</div>
                <div class="keyboard-key bg-gray-600 text-white rounded-lg" data-key="F">F</div>
                <div class="keyboard-key bg-gray-600 text-white rounded-lg" data-key="G">G</div>
                <div class="keyboard-key bg-gray-600 text-white rounded-lg" data-key="H">H</div>
                <div class="keyboard-key bg-gray-600 text-white rounded-lg" data-key="J">J</div>
                <div class="keyboard-key bg-gray-600 text-white rounded-lg" data-key="K">K</div>
                <div class="keyboard-key bg-gray-600 text-white rounded-lg" data-key="L">L</div>
            </div>
            <div class="flex justify-center space-x-1 sm:space-x-2">
                <button id="submit-btn" class="flex-grow bg-green-600 text-white font-bold rounded-lg shadow-md transition-colors hover:bg-green-500 border-b-4 border-green-700 text-sm py-1.5" style="width: 15vw; max-width: 5.5rem;">
                    Enter 
                </button>
                
                <div class="keyboard-key bg-gray-600 text-white rounded-lg" data-key="Z">Z</div>
                <div class="keyboard-key bg-gray-600 text-white rounded-lg" data-key="X">X</div>
                <div class="keyboard-key bg-gray-600 text-white rounded-lg" data-key="C">C</div>
                <div class="keyboard-key bg-gray-600 text-white rounded-lg" data-key="V">V</div>
                <div class="keyboard-key bg-gray-600 text-white rounded-lg" data-key="B">B</div>
                <div class="keyboard-key bg-gray-600 text-white rounded-lg" data-key="N">N</div>
                <div class="keyboard-key bg-gray-600 text-white rounded-lg" data-key="M">M</div>

                <button id="undo-btn" class="flex-grow bg-yellow-600 text-white font-bold rounded-lg shadow-md transition-colors hover:bg-yellow-500 border-b-4 border-yellow-700 text-xs py-1.5" style="width: 15vw; max-width: 5.5rem;">
                    Undo
                </button>
            </div>
        </div>
        
        </div>

</div> 
        
        <div id="how-to-play-modal" class="modal-overlay fixed inset-0 hidden items-center justify-center z-40 bg-black bg-opacity-70">
            <div class="modal-content bg-[#1e293b] rounded-lg shadow-2xl p-6 md:p-8 max-w-lg mx-4 border-t-4 border-purple-500 relative max-h-[90vh] overflow-y-auto">
                <button class="close-modal-btn absolute top-3 right-3 text-gray-400 hover:text-gray-100 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <div class="flex items-center text-3xl font-extrabold text-white mb-6 border-b border-gray-700 pb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 mr-3 text-purple-400">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712L12 15l-2.121-2.121c-1.172-1.025-1.172-2.687 0-3.712zM15 11.25a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                    </svg>
                    How To Play
                </div>

                <p class="text-xl mb-6 leading-relaxed">
                    To transform the <span class="font-bold text-purple-400">Start Word</span> <span class="bg-purple-700 text-white font-bold px-2 py-1 rounded-md">CAT</span> into the <span class="font-bold text-emerald-400">Goal Word</span> <span class="bg-emerald-700 text-white font-bold px-2 py-1 rounded-md">DOG</span> you must follow these rules:
                </p>

                <ul class="space-y-6 text-lg">
                    <li>
                        <div class="flex items-start">
                            <span class="mr-3 text-yellow-400 text-2xl">â€¢</span>
                            <p>You can change only <strong class="text-yellow-300">one letter</strong> from the current word to form the next one.</p>
                        </div>
                        <div class="bg-gray-700 p-3 rounded-md mt-2 ml-6 text-gray-200 text-lg font-mono flex items-center justify-center">
                            <span class="bg-purple-700 text-white font-bold px-2 py-1 rounded-md mr-2">CAT</span>
                            <span class="text-gray-400 text-xl mr-2">â†’</span>
                            <span class="bg-blue-700 text-white font-bold px-2 py-1 rounded-md">COT</span>
                        </div>
                    </li>
                    <li>
                        <div class="flex items-start">
                            <span class="mr-3 text-yellow-400 text-2xl">â€¢</span>
                            <p>Each word in the chain must be a <strong class="text-yellow-300">valid English word</strong>.</p>
                        </div>
                        <div class="bg-gray-700 p-3 rounded-md mt-2 ml-6 text-gray-200 text-lg font-mono flex items-center space-x-4 justify-center">
                            <div class="flex items-center">
                                <span class="bg-blue-700 text-white font-bold px-2 py-1 rounded-md mr-2">COT</span>
                                <span class="text-gray-400 text-xl mr-2">â†’</span>
                                <span class="bg-emerald-700 text-white font-bold px-2 py-1 rounded-md mr-2">COG</span>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-green-500">
                                    <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm13.36-1.814a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                    </li>
                    <li>
                        <div class="flex items-start">
                            <span class="mr-3 text-yellow-400 text-2xl">â€¢</span>
                            <p>You cannot <strong class="text-yellow-300">reuse a word</strong> already in your chain.</p>
                        </div>
                        <div class="bg-gray-700 p-3 rounded-md mt-2 ml-6 text-gray-200 text-lg font-mono flex items-center justify-center">
                            <span class="bg-blue-700 text-white font-bold px-2 py-1 rounded-md mr-2">COT</span>
                            <span class="text-gray-400 text-xl mr-2">â†’</span>
                            <span class="bg-emerald-700 text-white font-bold px-2 py-1 rounded-md mr-2">COG</span>
                            <span class="text-gray-400 text-xl mr-2">â†’</span>
                            <span class="bg-red-700 text-white font-bold px-2 py-1 rounded-md mr-2">COT</span>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-red-500 ml-2">
                                <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm-1.72 6.97a.75.75 0 10-1.06 1.06L10.94 12l-1.72 1.72a.75.75 0 101.06 1.06L12 13.06l1.72 1.72a.75.75 0 101.06-1.06L13.06 12l1.72-1.72a.75.75 0 10-1.06-1.06L12 10.94l-1.72-1.72z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </li>
                </ul>
            </div>
        </div>


        <div id="settings-modal" class="modal-overlay fixed inset-0 hidden items-center justify-center z-40 bg-black bg-opacity-70">
            <div class="modal-content bg-[#1e293b] rounded-lg shadow-2xl p-6 md:p-8 max-w-sm mx-4 border-t-4 border-purple-500 relative">
                <button class="close-modal-btn absolute top-3 right-3 text-gray-400 hover:text-gray-100 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <div class="flex items-center text-3xl font-extrabold text-white mb-6 border-b border-gray-700 pb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 mr-3 text-purple-400">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.514c.55 0 1.02.398 1.11.94 1.29.548 2.378 1.554 3.076 2.776 1.11 1.956 1.11 4.238 0 6.194a7.55 7.55 0 01-3.076 2.776c-.09.542-.56.94-1.11.94h-2.514c-.55 0-1.02-.398-1.11-.94a7.55 7.55 0 01-3.076-2.776c-1.11-1.956-1.11-4.238 0-6.194a7.55 7.55 0 013.076-2.776zM12 12.75a.75.75 0 100-1.5.75.75 0 000 1.5z" />
                    </svg>
                    Game Settings
                </div>

                <div class="bg-gray-700 rounded-lg p-4 flex items-center justify-between mb-8">
                    <div>
                        <p class="text-xl font-bold text-white mb-1">Allow Profanity</p>
                        <p class="text-sm text-gray-300">Allow potentially offensive or sensitive words.</p>
                    </div>
                    <label for="profanity-toggle" class="flex items-center cursor-pointer">
                        <div class="relative">
                            <input type="checkbox" id="profanity-toggle" class="sr-only" checked>
                            <div class="block bg-gray-500 w-14 h-8 rounded-full"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition-transform duration-300"></div>
                        </div>
                    </label>
                </div>

                <button class="close-modal-btn w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-full shadow-md transition-colors duration-200">
                    Close Settings
                </button>
            </div>
        </div>

        
        <div id="congrats-modal" class="fixed inset-0 hidden items-center justify-center z-40 bg-black bg-opacity-70">
            <div class="modal-content-congrats bg-[#1e293b] rounded-lg shadow-2xl p-8 max-w-sm mx-4 border-t-4 border-yellow-500 relative text-center">
                
                <div class="text-yellow-400 mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-16 h-16 mx-auto">
                        <path fill-rule="evenodd" d="M12 2.25a9.75 9.75 0 016.793 2.879l-4.27 4.27a.75.75 0 001.06 1.06l5.72-5.72a.75.75 0 000-1.061 9.75 9.75 0 00-13.844 0 9.75 9.75 0 000 13.788.75.75 0 10-1.06 1.061A11.25 11.25 0 1112 2.25zM21.5 12a9.75 9.75 0 00-6.793-9.375.75.75 0 00-.671 0A9.75 9.75 0 0012 2.25a.75.75 0 000 1.5c4.764 0 8.718 3.593 9.375 8.25-.008.012-.016.024-.024.036-.008.012-.016.024-.024.036zM12 12.75a.75.75 0 100 1.5.75.75 0 000-1.5z" clip-rule="evenodd" />
                    </svg>
                </div>
                
                <h2 class="congrats-title font-extrabold text-white mb-2">ðŸŽ‰ CONGRATULATIONS!</h2>
                <p class="text-lg sm:text-xl text-gray-300 mb-6">You successfully completed the level!</p>
                
                <div class="mb-8 p-4 bg-gray-700 rounded-lg">
                    <p class="text-xl font-medium text-white">Your Chain Length:</p>
                    <p id="final-steps-display" class="text-4xl sm:text-5xl font-extrabold text-yellow-400">0</p>
                </div>

                <div class="flex flex-col space-y-4">
                    <button id="next-level-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-full shadow-md transition-colors duration-200">
                        Next Challenge
                    </button>
                    <button id="back-to-menu-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 rounded-full shadow-md transition-colors duration-200">
                        Back to Menu
                    </button>
                </div>
            </div>
        </div>

    </div> 
    
    <script>
        // --- GAME STATE AND MOCK DATA ---
        let currentWord = [];
        let activePosition = null;
        let wordLength = 0;
        let wordTiles = []; // To be populated when game starts
        let currentHistory = []; // Tracks the chain of words

        const defaultTileBg = 'bg-purple-600';
        const activeTileBg = 'bg-red-600';
        const defaultTileBorder = 'border-purple-700';
        const activeTileBorder = 'border-red-700';
        
        // --- DOM Elements ---
        const levelSelectorScreen = document.getElementById('level-selector-screen');
        const gameScreen = document.getElementById('game-screen');
        const currentWordContainer = document.getElementById('current-word');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const levelDropdownButton = document.getElementById('level-dropdown-button');
        const levelDropdownMenu = document.getElementById('level-dropdown-menu');
        const stepsDisplayGame = document.getElementById('steps-display-game');
        const ladderHistory = document.getElementById('ladder-history');
        const historyScrollContainer = document.getElementById('history-scroll-container'); // New element
		const mainGameContainer = document.getElementById('game-container');
		

        // --- UTILITY FUNCTIONS ---
		
		// --- DICTIONARY & VALIDATION IMPLEMENTATION (FINAL) ---

		// This will hold the entire loaded JSON object: {"aaa": 1, "aah": 1, ...}
		let flatDictionary = null; 
		let isDictionaryLoaded = false;

		// Function to fetch and load the dictionary (Simplified)
		async function loadDictionary() {
			try {
				const response = await fetch('words_345_letter_dictionary.json'); 
				
				if (!response.ok) {
					throw new Error(`HTTP error! status: ${response.status}`);
				}
				
				// Store the entire flat dictionary object
				flatDictionary = await response.json(); 
				isDictionaryLoaded = true;

				console.log(`Dictionary loaded successfully. Total words: ${Object.keys(flatDictionary).length}`);
				showTemporaryMessage("Dictionary ready! Start the game.", '#10b981', 3000);

			} catch (error) {
				console.error("Failed to load dictionary:", error);
				showTemporaryMessage(`FATAL ERROR: Failed to load dictionary. Check console.`, '#ef4444', 8000);
			}
		}

		/**
		 * Checks the validity of a word against the dictionary and the required length.
		 * * @param {string} word - The word to check (will be converted to lowercase).
		 * @param {number} length - The required word length (3, 4, or 5).
		 * @returns {boolean} True if the word is valid and the correct length.
		 */
		function isValidWord(word, length) {
			if (!isDictionaryLoaded || !flatDictionary) {
				console.warn("Attempted to validate word before dictionary was loaded.");
				return false; 
			}
			
			// 1. Convert to lowercase, matching the keys in the JSON file
			const lowerWord = word.toLowerCase(); 
			
			// 2. Check the length rule first (must match the game's current length)
			if (lowerWord.length !== length) {
				// This check should mostly be handled by the gameLoop, but it's a good safeguard.
				return false; 
			}

			// 3. Check for existence in the flat dictionary object
			// Note: We use hasOwnProperty for maximum safety/clarity, though simple flatDictionary[lowerWord] is often fine too.
			const exists = flatDictionary.hasOwnProperty(lowerWord);

			// --- TEMPORARY DEBUGGING LOG (You can remove this later) ---
			console.log(`--- VALIDATION CHECK ---`);
			console.log(`Word: ${lowerWord}, Length: ${length}`);
			console.log(`Found in Dictionary? ${exists}`);
			console.log(`------------------------`);
			// -----------------------------------------------------------
			
			return exists;
		}
		
		/**
		 * Resets the current word display and the currentWord array to the last valid word in history.
		 */
		function revertWordDisplay() {
			// 1. Get the last valid word (which is the last element in the history array)
			const lastValidWord = currentHistory[currentHistory.length - 1];

			// 2. Reset the global currentWord array
			// This is crucial because input modifies this array directly
			currentWord = lastValidWord.split('');

			// 3. Update the visual tiles to match the last valid word
			// wordTiles is a global array of the letter tile DOM elements
			wordTiles.forEach((tile, index) => {
				tile.textContent = currentWord[index];
			});
		}

        // Function to convert a number to an ordinal string (1 -> 1st, 2 -> 2nd, etc.)
		function getOrdinal(n) {
			const s = ["th", "st", "nd", "rd"];
			const v = n % 100;
			return n + (s[(v - 20) % 10] || s[v] || s[0]);
		}

		// Display Alert Message
        let messageTimeout;
        function showTemporaryMessage(message, bgColor, duration = 3000) {
            clearTimeout(messageTimeout); 
            messageText.textContent = message;
            messageBox.style.backgroundColor = bgColor; 
            messageBox.style.visibility = 'visible';
            messageBox.style.opacity = 1;
            messageBox.style.pointerEvents = 'auto'; 

            messageTimeout = setTimeout(() => {
                messageBox.style.opacity = 0;
                setTimeout(() => {
                    messageBox.style.visibility = 'hidden';
                    messageBox.style.pointerEvents = 'none';
                }, 300); 
            }, duration);
        }
		
		/**
		 * Animates the word tiles sequentially with a 3D flip and color change, then opens the congrats modal.
		 */
		function animateWin() {
			const totalFlipTime = 400;  // ms for the full flip (200ms in, 200ms out)
			const delayPerTile = 100;   // ms sequential delay between tiles
			// Include any background classes your tiles might have
			const currentBgClasses = ['bg-purple-600', 'bg-blue-600', 'bg-red-600', 'bg-yellow-600']; 

				// 1. START THE PULSE ANIMATION IMMEDIATELY
				if (mainGameContainer) {
					mainGameContainer.classList.add('win-pulse'); 
				}
				
			wordTiles.forEach((tile, index) => {
				const sequentialDelay = index * delayPerTile;
				
				// --- STEP 1: Flip In (0ms to 200ms) ---
				setTimeout(() => {
					// Set transition for the first half of the flip
					tile.style.transition = 'transform 0.2s ease-in';
					// Rotate to 90 degrees (the invisible edge)
					tile.style.transform = 'rotateX(90deg)';
				}, sequentialDelay);

				// --- STEP 2: Color Change and Flip Out (200ms to 400ms) ---
				setTimeout(() => {
					// Remove old color classes and apply the winning style (color change happens here)
					tile.classList.remove(...currentBgClasses);
					tile.classList.add('win-tile');

					// Set transition for the second half of the flip
					tile.style.transition = 'transform 0.2s ease-out';
					// Rotate from 90 degrees back to 0 degrees
					tile.style.transform = 'rotateX(0deg)';
				}, sequentialDelay + totalFlipTime / 2); // Time is sequential delay + 200ms
			});

			// Calculate total time needed: (Tiles * delay) + Full flip time + Buffer
			const totalDelay = (wordTiles.length * delayPerTile) + totalFlipTime + 50; 
			
			// Open the modal and cleanup styles after all animations are complete
			setTimeout(() => {
			
				if (mainGameContainer) {
					mainGameContainer.classList.remove('win-pulse');
				}
				// Cleanup inline styles for the next game
				wordTiles.forEach(tile => {
					tile.style.transition = '';
					tile.style.transform = '';
					// Remove the win class, but keep the current word intact visually
				});

				// Open Modal
				document.getElementById('final-steps-display').textContent = currentHistory.length - 1;
				openModal('congrats-modal');
			}, totalDelay);
		}
        
        // Modal Handlers
        function openModal(modalId) {
            document.getElementById(modalId).classList.replace('hidden', 'flex');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.replace('flex', 'hidden');
        }

        // Resets all tiles to the default color
        function resetTileColors() {
            wordTiles.forEach(tile => {
                tile.classList.remove(activeTileBg, activeTileBorder, 'ring-4', 'ring-offset-2', 'ring-blue-400', 'ring-offset-gray-800', 'shadow-2xl');
                tile.classList.add(defaultTileBg, defaultTileBorder);
            });
        }

        function highlightActiveTile() {
            resetTileColors(); 
            if (activePosition !== null) {
                const tileIndex = activePosition - 1;
                const activeTile = wordTiles[tileIndex];
                if (activeTile) {
                    activeTile.classList.remove(defaultTileBg, defaultTileBorder);
                    activeTile.classList.add(activeTileBg, activeTileBorder, 'ring-4', 'ring-offset-2', 'ring-blue-400', 'ring-offset-gray-800', 'shadow-2xl');
                }
            }
        }
        
        // Function to scroll the history chain to the right (New)
        function scrollHistoryToRight() {
            if (historyScrollContainer) {
                // Use smooth scroll behavior
                historyScrollContainer.scroll({
                    left: historyScrollContainer.scrollWidth,
                    behavior: 'smooth'
                });
            }
        }


        // Screen Handlers
        function showLevelSelector() {
            // Hide all modals
            document.querySelectorAll('.modal-overlay').forEach(modal => modal.classList.add('hidden', 'flex'));
            
            gameScreen.classList.add('hidden');
            levelSelectorScreen.classList.remove('hidden');
            // Reset active state
            activePosition = null;
            currentWord = [];
        }

        function showGameScreen(wordLen, levelName, startWord, goalWord) {
            // Update UI elements based on selected level/game
            document.getElementById('game-title').textContent = `${wordLen}-Letter ${levelName.split(' ')[1]}`;
            document.getElementById('start-word-display').textContent = startWord;
            document.getElementById('goal-word-display').textContent = goalWord;
            
            // 1. Get the Goal Word
			const goal = document.getElementById('goal-word-display').textContent;
			// 2. Define the message
			const gameStartMessage = `Goal is '${goal}'! Start by selecting a letter to replace it.`;
			// 3. Display the message on game start
			showTemporaryMessage(gameStartMessage, '#3b82f6', 4000); // Use a blue background and 5-second duration
	
			// Initialize steps and history
            stepsDisplayGame.textContent = '0'; 
            ladderHistory.innerHTML = `<span class="px-1 py-0 bg-purple-600 text-white rounded-lg font-bold">${startWord}</span>`;
            currentHistory = [startWord];
            
            // Ensure history is scrolled to the start (left) initially
            scrollHistoryToRight();

            // Generate tiles
            currentWordContainer.innerHTML = '';
            currentWord = startWord.split('');
            currentWord.forEach((letter, index) => {
                const tile = document.createElement('div');
                tile.className = `letter-tile ${defaultTileBg} text-white rounded-xl shadow-md border-b-4 ${defaultTileBorder}`;
                tile.dataset.position = index + 1;
                tile.textContent = letter;
                tile.addEventListener('click', handleTileClick);
                currentWordContainer.appendChild(tile);
            });
            wordTiles = Array.from(document.querySelectorAll('#current-word > div'));
            
            // Hide selector, show game
            levelSelectorScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            wordLength = wordLen;
        }

        function handleTileClick(e) {
            const tile = e.target;
            const pos = parseInt(tile.dataset.position);
            
            activePosition = pos;
            highlightActiveTile();
            
            showTemporaryMessage(`${getOrdinal(activePosition)} letter selected. Enter a new letter.`, '#22c55e', 2000);
        }
        
        // --- ENHANCED GAME LOGIC (Integration of isValidWord) ---
		function gameLoop(newWord) {
			const goalWord = document.getElementById('goal-word-display').textContent;
			const currentWordUC = currentHistory[currentHistory.length - 1]; // Last confirmed word
			const newWordUC = newWord.toUpperCase();
			
			
			
			// 1. Length Check (Safety, though UI should prevent)
			if (newWordUC.length !== wordLength) {
				showTemporaryMessage(`Error: Word length mismatch. Must be ${wordLength} letters.`, '#ef4444');
				return;
			}

			// 2. Reuse Check
			if (currentHistory.includes(newWordUC)) {
				showTemporaryMessage(`Error: Word '${newWordUC}' already used in the chain.`, '#ef4444');
				return;
			}

			// 3. One-Letter Change Check
			let diffCount = 0;
			for (let i = 0; i < wordLength; i++) {
				if (newWordUC[i] !== currentWordUC[i]) {
					diffCount++;
				}
			}
			if (diffCount !== 1) {
				showTemporaryMessage(`Error: Word must change by exactly one letter from '${currentWordUC}'.`, '#ef4444');
				return;
			}
			
			// 4. Dictionary Check (The newly implemented core validation)
			if (!isValidWord(newWordUC, wordLength)) { // wordLength is the current game length
				
				// V A L I D A T I O N  E R R O R (Start Shake)
        
				// Use your existing variable: currentWordContainer
				currentWordContainer.classList.add('shake-error');

				// Remove the shake class after 400ms (the animation duration)
				setTimeout(() => {
					currentWordContainer.classList.remove('shake-error');
				}, 400);
				
				showTemporaryMessage(`Error: '${newWordUC}' is not a valid word.`, '#ef4444');
				revertWordDisplay(); // <-- Revert on error
				return;
			}

			// --- SUCCESSFUL MOVE ---
			currentHistory.push(newWordUC);
			stepsDisplayGame.textContent = currentHistory.length - 1; 
			
			// Update History (Using the teal/green color for the new current word)
			ladderHistory.innerHTML = currentHistory.map((word, index) => {
				const colorClass = index === 0 ? 'bg-purple-600' : (index === currentHistory.length - 1 ? 'bg-teal-500 text-gray-900' : 'bg-blue-600');
				const arrow = index > 0 ? `<span class="text-gray-400">&rarr;</span> ` : '';
				return `${arrow}<span class="px-1 py-0 ${colorClass} rounded-lg font-bold">${word}</span>`;
			}).join('');
			
			scrollHistoryToRight();

			// Update the current word display
			currentWord = newWordUC.split('');
			wordTiles.forEach((tile, index) => {
				tile.textContent = currentWord[index];
			});

			// Check for win condition
			if (newWordUC === goalWord) {
				animateWin();
				
				return; 
			}

			showTemporaryMessage(`Success! New word is ${newWordUC}.`, '#10b981'); 
		}

        // --- EVENT LISTENERS ---

        document.addEventListener('DOMContentLoaded', () => {
            // Initial state message
            showTemporaryMessage("Welcome! Select a level to start the game.", '#3b82f6', 4000);
			
			// --- NEW: Load the dictionary immediately on page load ---
            loadDictionary();

            // 1. LEVEL DROPDOWN TOGGLE
            levelDropdownButton.addEventListener('click', () => {
                levelDropdownMenu.classList.toggle('hidden');
                levelDropdownButton.setAttribute('aria-expanded', !levelDropdownMenu.classList.contains('hidden'));
            });

            // Close dropdown if click outside
            document.addEventListener('click', (e) => {
                if (!levelDropdownButton.contains(e.target) && !levelDropdownMenu.contains(e.target)) {
                    if (!levelDropdownMenu.classList.contains('hidden')) {
                        levelDropdownMenu.classList.add('hidden');
                        levelDropdownButton.setAttribute('aria-expanded', 'false');
                    }
                }
            });

            // 2. LEVEL SELECTION (Starts Game)
            document.querySelectorAll('.level-option').forEach(option => {
                option.addEventListener('click', () => {
                    const len = parseInt(option.dataset.wordLength);
                    const name = option.dataset.levelName;
                    
                    // MOCK: Replace with real word pair fetching later
                    let startWord = (len === 3) ? 'RUN' : (len === 4) ? 'COLD' : 'CLOTH';
                    // MOCK: Use 'KIN' for 3-letter to allow easy mock win
                    let goalWord = (len === 3) ? 'KIN' : (len === 4) ? 'WARM' : 'SMILE'; 
                    
                    levelDropdownMenu.classList.add('hidden');
                    showGameScreen(len, name, startWord, goalWord);
                });
            });

            // 3. MODAL CONTROLS (Open)
            document.querySelectorAll('.open-modal-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // Check if the clicked element is part of the button and get the data-modal
                    const modalId = e.currentTarget.dataset.modal; 
                    openModal(modalId);
                });
            });

            // 4. MODAL CONTROLS (Close)
            document.querySelectorAll('.close-modal-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Find the parent modal and close it
                    let modal = btn.closest('.fixed');
                    if (modal) {
                        closeModal(modal.id);
                    }
                });
            });

            // 5. GAME BUTTONS
			
			// New Reset Word Button: Resets the word display to the last confirmed word.
            document.getElementById('reset-word-btn').addEventListener('click', () => {
                if (currentHistory.length > 0) {
                    revertWordDisplay(); // The existing function is perfect for this!
                    activePosition = null; 
                    resetTileColors();
                    showTemporaryMessage("Current word reset to last valid move.", '#3b82f6', 1500);
                } else {
                    showTemporaryMessage("Cannot reset, no moves have been made.", '#ef4444', 1500);
                }
            });
			
            document.getElementById('quit-game-btn').addEventListener('click', () => {
                showTemporaryMessage("Quitting game...", '#8b5cf6', 1500);
                // In a real game, you might ask for confirmation here
                setTimeout(showLevelSelector, 1500);
            });

            document.getElementById('undo-btn').addEventListener('click', () => {
                if (currentHistory.length > 1) {
                    currentHistory.pop(); // Remove the last word
                    stepsDisplayGame.textContent = currentHistory.length - 1;
                    const newCurrentWord = currentHistory[currentHistory.length - 1];

                    // Update UI
                    currentWord = newCurrentWord.split('');
                    wordTiles.forEach((tile, index) => {
                        tile.textContent = currentWord[index];
                    });
                    
                    // Re-render history
                    ladderHistory.innerHTML = currentHistory.map((word, index) => {
                        const colorClass = index === 0 ? 'bg-purple-600' : (index === currentHistory.length - 1 ? 'bg-teal-500 text-gray-900' : 'bg-blue-600');
                        const arrow = index > 0 ? `<span class="text-gray-400">&rarr;</span> ` : '';
                        return `${arrow}<span class="px-1 py-0 ${colorClass} rounded-lg font-bold">${word}</span>`;
                    }).join('');

                    // Scroll to the rightmost side after update (New)
                    scrollHistoryToRight();

                    showTemporaryMessage("Last move undone.", '#10b981', 1500);
                } else {
                    showTemporaryMessage("Cannot undo the starting word.", '#ef4444', 1500);
                }
            });
            
            // 6. CONGRATS BUTTONS
            document.getElementById('back-to-menu-btn').addEventListener('click', () => {
                closeModal('congrats-modal');
                showLevelSelector();
            });
            document.getElementById('next-level-btn').addEventListener('click', () => {
                closeModal('congrats-modal');
                showTemporaryMessage("Mocking next level start...", '#10b981', 2000);
                // TODO: Implement logic to start the next level, perhaps with a different word length
                setTimeout(showLevelSelector, 2000); // For now, just go back to menu after a delay
            });

            // 7. KEYBOARD INPUT LOGIC (Defined inside DOMContentLoaded for scope access)
            document.getElementById('keyboard').addEventListener('click', (e) => {
                const keyElement = e.target.closest('.keyboard-key');
                if (keyElement && !gameScreen.classList.contains('hidden')) { // Only allow input when game is active
                    const key = keyElement.dataset.key;
                    
                    if (activePosition !== null) {
                        const tileIndex = activePosition - 1;
                        const tile = wordTiles[tileIndex];

                        if (tileIndex >= 0 && tileIndex < currentWord.length) {
                            currentWord[tileIndex] = key;
                            tile.textContent = key;
                            
                            // Deactivate selection after input
                            activePosition = null; 
                            resetTileColors();

                            showTemporaryMessage(`Letter changed to '${key}'.`, '#f59e0b', 1000); 
                        }
                    } else {
                        showTemporaryMessage("Click a letter to select a position first!", '#ef4444', 1500);
                    }
                }
            });

            // 8. SUBMIT BUTTON LOGIC
            document.getElementById('submit-btn').addEventListener('click', () => {
                activePosition = null; // Deactivate selection
                resetTileColors(); // Ensure all tiles revert to default color

                const newWord = currentWord.join('');
                gameLoop(newWord); // Use the new gameLoop function
            });

        });
    </script>
</body>
</html>